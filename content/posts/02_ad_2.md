---
title: "ğŸ§™â€â€â™€ï¸ Differentiation with Rust 02: Automatic Differentiation"
date: 2020-08-30T03:36:49+09:00
draft: true
toc: true
images:
tags:
  - numerical
  - automatic differentiation
  - rust
---

> **ğŸ”– Automatic Differentiation Series**
>
> 1. [ğŸ’» Numerical Differentiation](../02_ad_1)
> 2. [ğŸ§™â€â€â™€ï¸ Automatic Differentiation](../02_ad_2)

## ìˆ˜ì¹˜ì  ë¯¸ë¶„ì˜ í•œê³„

ì €ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œ ìˆ˜ì¹˜ì  ë¯¸ë¶„ì„ ì—¬ëŸ¬ê°€ì§€ ë°©ë²•ìœ¼ë¡œ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ë‹¤ë¤„ë³´ì•˜ëŠ”ë°, ì–´ë– ì…¨ë‚˜ìš”?
ì•„ë§ˆ, ì½”ë”©ì— ëŒ€í•œ ì¡°ê¸ˆì˜ ì§€ì‹ë§Œ ìˆìœ¼ë©´ ì˜¤íˆë ¤ ê³ ë“±í•™êµë•Œì˜ ë¯¸ë¶„ë³´ë‹¤ í›¨ì”¬ ì‰½ê²Œ ëŠê»´ì§€ì…¨ì„ ê²ë‹ˆë‹¤.
ì €í¬ê°€ ì‚¬ìš©í•œ ê²ƒì´ë¼ê³ ëŠ” ê·¸ì € ë„í•¨ìˆ˜ì˜ ì •ì˜ì— ë”°ë¼ í•¨ìˆ˜ì— ê° êµ¬ê°„ ê°’ì„ ëŒ€ì…í•œ ê²ƒì´ ì „ë¶€ì˜€ëŠ”ë°, ì´ë¥¼ ì½”ë“œë¡œ ë‚˜íƒ€ë‚´ë©´ ê²°êµ­ ë‹¤ìŒì˜ ì½”ë“œì— ì§€ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```python
# Python
def differentiation(f, x, h=1e-06):
  return (f(x + h) - f(x)) / h
```

ë‚˜ë¨¸ì§€ëŠ” ì´ë¥¼ ê°ì²´ì§€í–¥ì ìœ¼ë¡œ êµ¬í˜„í•˜ê±°ë‚˜, í•¨ìˆ˜í˜• í”„ë¡œê·¸ë˜ë°ìœ¼ë¡œ êµ¬í˜„í•˜ê±°ë‚˜ ì œë„ˆë¦­ í”„ë¡œê·¸ë˜ë°ì„ ë„ì…í•˜ëŠ” ë“±ì˜ êµ¬í˜„ë°©ë²•ì˜ ì°¨ì´ì¼ ë¿ì´ì—ˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ ìˆ˜ì¹˜ì  ë¯¸ë¶„ ë°©ë²•ì€ êµ‰ì¥íˆ ê°„ë‹¨í•œ êµ¬í˜„ê³¼ ì—„ì²­ ë¹ ë¥¸ ê³„ì‚°ì†ë„ë¥¼ ê°€ì ¸ì„œ ëˆ„êµ¬ë‚˜ ì‰½ê²Œ ë¯¸ë¶„ì„ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ì—ˆìŠµë‹ˆë‹¤ë§Œ, ì˜¤ì°¨ê°€ í•„ì—°ì ìœ¼ë¡œ ë°œìƒí•˜ê²Œ ë˜ëŠ” ë‹¨ì ì´ ìˆì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì˜¤ì°¨ì— í¬ê²Œ ë¯¼ê°í•˜ì§€ ì•Šì€ ë¬¸ì œë‚˜, Step ìˆ˜ê°€ ì ì–´ì„œ ì˜¤ì°¨ê°€ í¬ê²Œ ìŒ“ì´ì§€ ì•ŠëŠ” ë¯¸ë¶„ë°©ì •ì‹ì„ í‘¸ëŠ” ê²½ìš°ì—” ì¶©ë¶„í•˜ì§€ë§Œ, ì˜¤ì°¨ì— ë¯¼ê°í•˜ê±°ë‚˜ Step ìˆ˜ê°€ ë§ì•„ì„œ ì˜¤ì°¨ê°€ ìŒ“ì—¬ ìœ ì˜ë¯¸í•œ ì°¨ì´ë¥¼ ë³´ì—¬ì£¼ëŠ” ë¯¸ë¶„ë°©ì •ì‹ì˜ ê²½ìš°ì—” í° ë¬¸ì œë¥¼ ì•¼ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëŒ€í‘œì ì¸ ì˜ˆì‹œë¡œ "ë¡œë Œì¦ˆì˜ ë‚˜ë¹„"ê°€ ìˆìŠµë‹ˆë‹¤.

### ë¡œë Œì¦ˆì˜ ë‚˜ë¹„

![Lorenz Butterfly](/posts/images/euler.png)

ì—ë“œì›Œë“œ ë¡œë Œì¦ˆëŠ” ê±¸ì¶œí•œ ìˆ˜í•™ìë¡œ, íŠ¹íˆ ì¹´ì˜¤ìŠ¤ ì´ë¡ ì˜ ì„ êµ¬ìë¡œ ìœ ëª…í•˜ì‹  ë¶„ì…ë‹ˆë‹¤. ê·¸ëŠ” 1963ë…„ì— ëŒ€ê¸° ëŒ€ë¥˜ì˜ ê°„ë‹¨í•œ ìˆ˜í•™ì  ëª¨í˜•ì„ ë§Œë“¤ì—ˆëŠ”ë°, ì´ ëª¨ë¸ì€ ë‹¤ìŒì˜ 3ê°œì˜ ìƒë¯¸ë¶„ë°©ì •ì‹ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.

$$
\begin{align}
\frac{dx}{dt} &= \sigma(y-x) \\\\
\frac{dy}{dt} &= x (\rho - z) - y \\\\
\frac{dz}{dt} &= xy - \beta z
\end{align}
$$

ë¶„ëª… ì•„ì£¼ ê°„ë‹¨í•œ ë¯¸ë¶„ë°©ì •ì‹ì¸ë°, ë†€ëê²Œë„ ì•„ì£¼ ë³µì¡í•œ í˜•íƒœì˜ í•´ê°€ ë„ì¶œë©ë‹ˆë‹¤. ì´ë•Œì˜ ëŒ€í‘œì ì¸ í•´ì˜ í˜•íƒœê°€ ìœ„ì—ì„œ ì²¨ë¶€í•œ ê·¸ë¦¼ì…ë‹ˆë‹¤. ì´ ì‹œìŠ¤í…œì€ êµ‰ì¥íˆ ì˜ˆë¯¼í•œë°, ë§¤ê°œë³€ìˆ˜ì˜ ê°’ì„ ì¡°ê¸ˆ ë°”ê¾¸ê±°ë‚˜ í˜¹ì€ Step sizeë¥¼ ì¡°ê¸ˆë§Œ ë°”ê¿”ë„ í•´ì˜ í˜•íƒœëŠ” ì˜ˆì¸¡í•  ìˆ˜ ì—†ëŠ” í˜•íƒœë¡œ, ê·¸ê²ƒë„ êµ‰ì¥íˆ íŒŒê²©ì ìœ¼ë¡œ ë³€í˜•ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ìœ„ì˜ ê·¸ë¦¼ì€ **ì˜¤ì¼ëŸ¬**(Euler) ë°©ë²•ì´ë¼ëŠ” ìˆ˜ì¹˜ì  ë¯¸ë¶„ë°©ì •ì‹ í•´ë²• ì¤‘ í•˜ë‚˜ë¡œ í’€ì—ˆëŠ”ë°, ìœ„ì™€ ëª¨ë“  ì¡°ê±´ì„ ë™ì¼í•˜ê²Œ ë†“ê³  ë°©ë²•ë§Œ **ë£½ê²Œ-ì¿ íƒ€**(Runge-Kutta 4th order) ë°©ë²•ìœ¼ë¡œ ë°”ê¾¸ë©´ ë‹¤ìŒì˜ ê·¸ë¦¼ì´ ë‚˜ì˜µë‹ˆë‹¤.

![Lorenz Butterfly (RK4)](/posts/images/rk4.png)

ì˜¤ë¡œì§€ ë°©ë²•ë§Œ ë°”ê¾¸ì—ˆì„ ë¿ì¸ë° ê²°ê³¼ê°€ ìƒë‹¹íˆ ë§ì´ ë‹¤ë¥¸ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¬¼ë¡  ì´ ê²½ìš°ì—ëŠ” ì „ì²´ì ì¸ í˜•íƒœëŠ” ë°”ë€Œì§€ ì•Šì§€ë§Œ, íŠ¹ì • ë§¤ê°œë³€ìˆ˜ ì£¼ë³€ì—ì„œëŠ” ì•„ì˜ˆ í˜•íƒœ ì „ì²´ê°€ ê¸‰ê²©í•˜ê²Œ ë³€í˜•ë˜ëŠ” ê²½ìš°ë„ ë°œìƒí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê²½ìš°ì—ëŠ” ì˜¤ì°¨ê°€ í•„ì—°ì ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ìˆ˜ì¹˜ì  ë¯¸ë¶„ ë°©ë²•ì´ ì í•©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ ì´ëŸ° ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ í’€ì–´ì•¼ í• ê¹Œìš”?

-----

## ìë™ ë¯¸ë¶„

-----

## ë¶€ë¡

### A. ë¡œë Œì¦ˆ ë‚˜ë¹„ ì½”ë“œ

ìœ„ì—ì„œ ì²¨ë¶€í•œ ë¡œë Œì¦ˆ ë‚˜ë¹„ ê·¸ë¦¼ë“¤ì€ Rustì˜ ìˆ˜ì¹˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ [Peroxide](https://github.com/Axect/Peroxide)ë¥¼ ì´ìš©í•˜ì—¬ ê³„ì‚°í•˜ì˜€ìŠµë‹ˆë‹¤. ì†ŒìŠ¤ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```rust
extern crate peroxide;
use peroxide::fuga::*;

fn main() -> Result<(), Box<dyn Error>> {
    // =========================================
    //  Declare ODE
    // =========================================
    let mut ex_test = ExplicitODE::new(butterfly);

    let init_state: State<f64> = State::new(
        0.0,
        vec![10.0, 1.0, 1.0],
        vec![0.0, 0.0, 0.0],
    );

    ex_test
        .set_initial_condition(init_state)
        .set_method(ExMethod::Euler)
        .set_step_size(0.01f64)
        .set_times(10000);

    let mut ex_test2 = ex_test.clone();
    ex_test2.set_method(ExMethod::RK4);

    // =========================================
    //  Save results
    // =========================================
    let results = ex_test.integrate();
    let results2 = ex_test2.integrate();

    let mut df_euler = DataFrame::from_matrix(results);
    df_euler.set_header(vec!["t", "x", "y", "z"]);
    df_euler.print();

    let mut df_rk4 = DataFrame::from_matrix(results2);
    df_rk4.set_header(vec!["t", "x", "y", "z"]);
    df_rk4.print();

    df_euler.write_nc("data/euler.nc")?;
    df_rk4.write_nc("data/rk4.nc")?;

    Ok(())
}

fn butterfly(st: &mut State<f64>, _: &NoEnv) {
    let x = &st.value;
    let dx = &mut st.deriv;
    dx[0] = 10f64 * (x[1] - x[0]);
    dx[1] = 28f64 * x[0] - x[1] - x[0] * x[2];
    dx[2] = -8f64/3f64 * x[2] + x[0] * x[1];
}
```

ì´í›„ì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì„œ ê·¸ë¦¼ì„ ê·¸ë¦¬ëŠ” ê²ƒì€ Pythonìœ¼ë¡œ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```python
from netCDF4 import Dataset
import matplotlib.pyplot as plt

# Import netCDF file
ncfile1 = './data/euler.nc'
data1 = Dataset(ncfile1)
var1 = data1.variables
ncfile2 = './data/rk4.nc'
data2 = Dataset(ncfile2)
var2 = data2.variables

# Use latex
plt.rc('text', usetex=True)
plt.rc('font', family='serif')

# Prepare Plot
plt.figure(figsize=(10,6), dpi=300)
plt.title(r"Lorenz Butterfly (Euler)", fontsize=16)
plt.xlabel(r'$x$', fontsize=14)
plt.ylabel(r'$z$', fontsize=14)

# Prepare Data to Plot
x1 = var1['x'][:]
z1 = var1['z'][:]  

# Plot with Legends
plt.plot(x1, z1, label=r'Lorenz (Euler)')

# Other options
plt.legend(fontsize=12)
plt.grid()
plt.savefig("euler.png", dpi=300)

# Prepare Plot
plt.figure(figsize=(10,6), dpi=300)
plt.title(r"Lorenz Butterfly (RK4)", fontsize=16)
plt.xlabel(r'$x$', fontsize=14)
plt.ylabel(r'$z$', fontsize=14)

# Prepare Data to Plot
x2 = var2['x'][:]
z2 = var2['z'][:]  

# Plot with Legends
plt.plot(x2, z2, label=r'Lorenz (RK4)')

# Other options
plt.legend(fontsize=12)
plt.grid()
plt.savefig("rk4.png", dpi=300)
```

ì´ì™¸ì— ìì„¸í•œ ì‚¬í•­ì€ [Peroxide Gallery](https://github.com/Axect/Peroxide_Gallery)ì— ë‚˜ì™€ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.