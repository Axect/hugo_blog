---
title: "ğŸ“Š Piecewise Rejection Sampling"
date: 2022-11-18T17:49:04+09:00
draft: false
toc: true
images:
tags:
  - statistics
  - piecewise rejection sampling
---

{{<img src="/posts/images/006_01_test_dist.png" caption="Differential energy spectrum of ALPs from primordial black hole (PBH)[${}^{[1]}$](#footnotes)">}}

&emsp;&emsp;Let's assume someone brings you an unnormalized probability density function graph like the one above. Then, they ask you to create 10,000 pieces of data with such a probability distribution, what should you do?

First of all, the two best-known methods for sampling data from an arbitrary probability density function are as follows:

1. [Inverse Transform Sampling](https://en.wikipedia.org/wiki/Inverse_transform_sampling)
2. [Rejection Sampling](https://en.wikipedia.org/wiki/Rejection_sampling)

Inverse Transform Sampling is a method of generating data by finding the cumulative distribution function of the probability density function, finding the inverse function of that cumulative distribution function, and then using that inverse function to generate data. This method is efficient, but depending on what form the probability density function takes, the way to find it changes, so it is difficult to use when you don't know the exact form of the probability density function like in our current case[${}^{[2]}$](#footnotes). However, Rejection Sampling can be applied regardless of the form of the probability density function, so we will start with this method.


-----

## 1. Rejection Sampling

&emsp;&emsp;{{<emph "Rejection sampling ">}}(í˜¹ì€ Acceptance-rejection method)ì˜ ì•Œê³ ë¦¬ì¦˜ì€ ë§¤ìš° ê°„ë‹¨í•œ í¸ì…ë‹ˆë‹¤. ì´ë¥¼ ì„¤ëª…í•˜ê¸° ìœ„í•´ ì €í¬ê°€ samplingí•˜ê³  ì‹¶ì€ í™•ë¥ ë¶„í¬ì˜ í™•ë¥ ë°€ë„í•¨ìˆ˜ë¥¼ $f(x)$ë¼ ëª…ëª…í•˜ê² ìŠµë‹ˆë‹¤.
í•˜ì§€ë§Œ ìš°ë¦¬ëŠ” $f(x)$ë¡œë¶€í„° ë°”ë¡œ samplingí•˜ëŠ” ë°©ë²•ì„ ëª¨ë¥´ë¯€ë¡œ sampling í•  ìˆ˜ ìˆëŠ” í™•ë¥ ë°€ë„í•¨ìˆ˜ì¸ $g(x)$ë¥¼ ë„ì…í•©ë‹ˆë‹¤. ì´ë•Œ, $g(x)$ëŠ” íŠ¹ì •í•œ ì–‘ì˜ ìƒìˆ˜ $M$ì— ëŒ€í•˜ì—¬ ì •ì˜ì—­ì˜ ëª¨ë“  $x$ì— ëŒ€í•˜ì—¬ $f(x) \leq M \cdot g(x)$ ì¡°ê±´ì´ ì„±ë¦½í•´ì•¼í•©ë‹ˆë‹¤. ì´ë¥¼ ê·¸ë¦¼ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

{{<img src="/posts/images/006_02_rejection.svg" caption="ì…ìë¬¼ë¦¬ì—ì„œ ìì£¼ ë³¼ ìˆ˜ ìˆëŠ” ê·¸ë˜í”„" width="80%" align="center">}}

ë³´í†µ samplingí•˜ê¸° ê°€ì¥ ì‰¬ìš´ í™•ë¥ ë¶„í¬ëŠ” Uniform distribution(ê· ë“±ë¶„í¬)ì´ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” $g(x)=\text{Unif}(x|0,10)$ìœ¼ë¡œ ì •ì˜í•˜ì˜€ìŠµë‹ˆë‹¤. ë˜í•œ $f(x)$ì˜ ìµœëŒ“ê°’ì´ 1ì´ë¯€ë¡œ $M=10$ìœ¼ë¡œ ì •í•˜ì—¬ $M\times g(x)$ê°€ í•­ìƒ $f(x)$ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ìŒì„ ë³´ì¥í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ì œ ì´ ê·¸ë˜í”„ë¥¼ ì´ìš©í•˜ì—¬ samplingí•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

1. $y$ë¥¼ $g(x)$ë¡œ ë¶€í„° samplingí•©ë‹ˆë‹¤. ì´ ê²½ìš°ì—” $y$ëŠ” $\text{Unif}(x|0,10)$ë¡œë¶€í„° samplingëœ ê°’ì´ ë©ë‹ˆë‹¤.

2. ê·¸ë ‡ê²Œ ì¶”ì¶œëœ $y$ì— ëŒ€í•˜ì—¬ ë˜ ë‹¤ë¥¸ ê· ë“±ë¶„í¬ì¸ $\text{Unif}(u|0,M\times g(y))$ë¡œë¶€í„° $u$ë¥¼ samplingí•©ë‹ˆë‹¤. (ì´ëŠ” $g(x)$ì˜ í˜•íƒœì™€ ë³„ê°œë¡œ í•­ìƒ ê· ë“±ë¶„í¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.)

3. ë§Œì•½ $u \leq f(y)$ì´ë©´ $y$ë¥¼ ìš°ë¦¬ê°€ samplingí•˜ê³ ì í•˜ëŠ” í™•ë¥ ë¶„í¬ $f(x)$ë¡œë¶€í„° samplingëœ ê°’ìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë‹¤ì‹œ 1ë²ˆìœ¼ë¡œ ëŒì•„ê°€ì„œ $y$ë¥¼ samplingí•©ë‹ˆë‹¤.

ì´ sampling ë°©ë²•ì´ {{<emph "Rejection sampling(ê¸°ê° ìƒ˜í”Œë§)">}}ì…ë‹ˆë‹¤. 3ë²ˆì—ì„œ ë³´ë‹¤ì‹œí”¼ $u$ê°€ $f(y)$ë³´ë‹¤ í¬ë‹¤ë©´ ê¸°ê°í•˜ê¸° ë•Œë¬¸ì— ë¶™ì—¬ì§„ ì´ë¦„ì…ë‹ˆë‹¤. ì´ ê°„ë‹¨í•œ ì•Œê³ ë¦¬ì¦˜ ë§Œìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œìš´ í™•ë¥ ë¶„í¬ì¸ $f(x)$ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ê·¼ì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ëˆ„ì í™•ë¥ ë¶„í¬í•¨ìˆ˜(CDF)ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

> í™•ë¥ ë³€ìˆ˜ $X$ë¥¼ Rejection samplingìœ¼ë¡œ ì–»ì–´ì§„ í™•ë¥ ë³€ìˆ˜ë¼ í•˜ë©´, ë‹¤ë¥¸ ë‘ í™•ë¥ ë³€ìˆ˜ $Y \sim g(y)$, $U \sim \text{Unif}(u|0, M\cdot g(y))$ì— ëŒ€í•˜ì—¬  ë‹¤ìŒê³¼ ê°™ì€ ê´€ê³„ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> $$
> P(X \leq x) = P\left(Y \leq x \\,|\\, U < f(Y)\right)
> $$
> ìš°ë³€ì˜ ì¡°ê±´ë¶€ í™•ë¥ ì€ $U$ê°€ ê¸°ê°ë˜ì§€ ì•Šì•˜ì„ ë•Œ, $Y$ê°€ $x$ë³´ë‹¤ ì‘ì„ í™•ë¥ ì´ë©° ì´ëŠ” ìœ„ì˜ ì•Œê³ ë¦¬ì¦˜ì—ì„œ 3ë²ˆê³¼ ê°™ìŠµë‹ˆë‹¤.
> ì´ë¥¼ ì¡°ê±´ë¶€ í™•ë¥ ì˜ ì •ì˜ë¥¼ ì´ìš©í•˜ì—¬ ë³€í˜•í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
> $$
> P(X \leq x) = \frac{P (Y \leq x,~U < f(Y))}{P(U < f(Y))}
> $$
> ë¨¼ì € ìœ„ ì‹ì˜ ë¶„ìë¥¼ í™•ë¥ ë°€ë„í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ ì „ê°œí•´ë³´ê² ìŠµë‹ˆë‹¤.
> $$
> \begin{aligned}
> P(Y \leq x,U < f(Y)) &= \int P(Y \leq x,U < f(Y) | Y = y) \cdot g(y) \\,dy \\\\
> &= \int P(y \leq x,~U < f(y)) \cdot g(y) \\,dy \\\\
> &= \int ğŸ™_{y \leq x} \cdot P(U < f(y))\cdot  g(y) \\, dy \\\\
> &= \int_{-\infty}^x P(U < f(y)) \cdot g(y) \\, dy
> \end{aligned}
> $$
> 2ë²ˆì§¸ ì‹ì—ì„œ 3ë²ˆì§¸ë¡œ ë„˜ì–´ê°ˆë•ŒëŠ” $y \leq x$ì™€ $U < f(y)$ëŠ” ë…ë¦½ì´ë¼ëŠ” ì¡°ê±´ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ì œ $U \sim \text{Unif}(u|0,\\,M\cdot g(y))$ì´ë¯€ë¡œ $\displaystyle P(U < f(y)) = \frac{1}{M\cdot g(y)} \times (f(y) - 0)$ì„ ëŒ€ì…í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
> $$
> \begin{aligned}
> P(Y \leq x,~U < f(Y)) &= \int_{-\infty}^x \frac{f(y)}{M\cdot g(y)}\cdot g(y) \\, dy \\\\
> &= \frac{1}{M} \int_{-\infty}^x f(y) \\, dy
> \end{aligned}
> $$
> <br/>
> ì´ì œ ë¶„ëª¨ë¥¼ êµ¬í•´ë³´ê² ìŠµë‹ˆë‹¤.
> $$
> \begin{aligned}
> P(U < f(Y)) &= \int P(U < f(y)) \cdot g(y) \\, dy \\\\
> &= \int \frac{f(y)}{M\cdot g(y)} \cdot g(y) \\, dy \\\\
> &= \frac{1}{M} \int f(y) \\, dy \\\\
> &= \frac{1}{M}
> \end{aligned}
> $$
> ë§ˆì§€ë§‰ìœ¼ë¡œ ë¶„ìì™€ ë¶„ëª¨ë¥¼ ë‚˜ëˆ„ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
> $$
> P(X \leq x) = \int_{-\infty}^x f(y) \\, dy
> $$
> ì´ëŠ” $f(x)$ì˜ ëˆ„ì ë¶„í¬í•¨ìˆ˜ì™€ ê°™ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ Rejection samplingìœ¼ë¡œ ì–»ì–´ì§„ í™•ë¥ ë³€ìˆ˜ $X$ì˜ í™•ë¥ ë°€ë„í•¨ìˆ˜ëŠ” $f(x)$ë¼ëŠ” ê²ƒì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ ìˆ˜í•™ì ìœ¼ë¡œ ì¦ëª…ì„ ë§ˆì³¤ìœ¼ë‹ˆ, ì´ë²ˆì—ëŠ” ì´ê²ƒì´ ì‹¤ì œë¡œ ì˜ ì‘ë™í•˜ëŠ”ì§€ ì½”ë“œë¥¼ ì‘ì„±í•´ë´…ì‹œë‹¤.

```rust
// Rust
use peroxide::fuga::*;

const M: f64 = 10.0;
const N: usize = 100_000;

fn main() {
    // Create g(x)=Unif(x|0,10) & h(y)=Unif(y|0,M)
    let g = Uniform(0.0, 10.0);
    let h = Uniform(0.0, M);

    // Rejection sampling
    let mut x_vec = vec![0f64; N];
    let mut i = 0usize;
    while i < N {
        let x = g.sample(1)[0];
        let y = h.sample(1)[0];

        if y <= f(x) {      // Accept
            x_vec[i] = x;
            i += 1;
        } else {            // Reject
            continue;
        }
    }

    // ...
}

// Test function
fn f(x: f64) -> f64 {
    1f64 / (x+1f64).sqrt() + 0.2 * (-(x-3f64).powi(2) / 0.2).exp()
}
```
ì•Œê³ ë¦¬ì¦˜ ìì²´ê°€ ê°„ë‹¨í•˜ë¯€ë¡œ ì½”ë“œ ì—­ì‹œ êµ‰ì¥íˆ ê°„ë‹¨í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ê·¸ëŸ¼ì—ë„ ê²°ê³¼ëŠ” ë›°ì–´ë‚©ë‹ˆë‹¤.

{{<img src="/posts/images/006_03_hist.png" caption="Result of rejection sampling" width=80% align="center">}}

í™•ë¥ ë°€ë„í•¨ìˆ˜ì˜ í˜•íƒœì— êµ¬ì• ë°›ì§€ ì•Šìœ¼ë©° êµ¬í˜„ê¹Œì§€ ì‰¬ìš´ Rejection samplingì´ì§€ë§Œ ì¹˜ëª…ì ì¸ ë‹¨ì  ì—­ì‹œ ì¡´ì¬í•©ë‹ˆë‹¤. ë°”ë¡œ ê³„ì‚° íš¨ìœ¨ì´ êµ‰ì¥íˆ ë–¨ì–´ì§„ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. Rejection samplingì—ì„œ sampleì„ í™•ë³´í•˜ë ¤ë©´ ê¸°ê° ì¡°ê±´ì—ì„œ ì‚´ì•„ë‚¨ì•„ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ì¦‰, $P(U < f(Y))$ê°€ ë†’ì„ ìˆ˜ë¡ ë¹ ë¥´ê²Œ sampleì„ í™•ë³´í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ê³  ë°˜ëŒ€ë¡œ ë‚®ì„ ìˆ˜ë¡ ì¶©ë¶„í•œ ìˆ˜ì˜ sampleì„ í™•ë³´í•˜ê¸°ê¹Œì§€ ì˜¤ë˜ ê±¸ë¦°ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ë¥¼ {{<emph "Acceptance rate">}}(ìŠ¹ì¸ ë¹„ìœ¨)ë¼ê³  í•˜ë©° ì´ëŠ” ì´ë¯¸ ìœ„ì˜ ì¦ëª…ì—ì„œ ê³„ì‚°í•˜ì˜€ìŠµë‹ˆë‹¤.

{{<note title="Acceptance rate">}}
Rejectionì˜ Acceptace rateëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜ëœë‹¤.
$$
P(U < f(Y)) = \int P(U < f(y)) \cdot g(y) \\, dy
$$
{{</note>}}

ì €í¬ê°€ ì‚¬ìš©í•œ ì•Œê³ ë¦¬ì¦˜ì—ì„œëŠ” ì´ëŠ” $1/M$ê³¼ ê°™ê³ , ì´ëŠ” $f(x)$ê°€ ì°¨ì§€í•˜ëŠ” ë„“ì´ë¥¼ $M \cdot g(x)$ê°€ ì°¨ì§€í•˜ëŠ” ì „ì²´ ë„“ì´ë¡œ ë‚˜ëˆˆ ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ë¶„í¬ê°„ì˜ ì°¨ì´ê°€ í¬ë©´ í´ìˆ˜ë¡ Acceptance rateê°€ ë‚®ì•„ì§€ê³  ê·¸ë§Œí¼ sampleì„ í™•ë³´í•˜ëŠ”ë° ì˜¤ëœ ì‹œê°„ì´ ê±¸ë¦°ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
ê·¸ë‚˜ë§ˆ ì €í¬ê°€ ì‚¬ìš©í•œ ì˜ˆì‹œëŠ” $g(x)$ì™€ $f(x)$ì˜ ì°¨ì´ê°€ í° ë¶€ë¶„ì´ ë§ì§€ ì•Šì•„ì„œ ë¹„êµì  ê´œì°®ìŠµë‹ˆë‹¤ë§Œ, ì‹œì‘í•  ë•Œ ì œì‹œí•˜ì˜€ë˜ í™•ë¥ ë¶„í¬ì²˜ëŸ¼ 0ì¸ ë¶€ë¶„ì´ ë§ì€ ê²½ìš°ì—ëŠ” $g(x)$ë¡œ Uniform distributionì„ ì‚¬ìš©í•œë‹¤ë©´ ëŒ€ë¶€ë¶„ ê¸°ê°ë˜ì–´ë²„ë¦¬ê¸° ë•Œë¬¸ì— ì‹œê°„ì´ ì˜¤ë˜ê±¸ë¦´ë¿ë”ëŸ¬ ê±°ì˜ 0 ê·¼ì²˜ì˜ tailì— ëŒ€í•´ì„œëŠ” samplingì´ ë¶ˆê°€ëŠ¥í•œ ì§€ê²½ì—ê¹Œì§€ ì´ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ ì´ë¥¼ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œìš”?

-----

## 2. Piecewise Rejection Sampling

&emsp;&emsp;ì‚¬ì‹¤ ì´ë¯¸ ì—°êµ¬ìë“¤ì€ ì´ëŸ° ê²½ìš°ë¥¼ ìœ„í•´ ì—¬ëŸ¬ê°€ì§€ ë°©ë²•ì„ ê³ ì•ˆí•´ë‘ì—ˆìŠµë‹ˆë‹¤. ëŒ€í‘œì ìœ¼ë¡œ {{<emph "Adaptive Rejection Sampling (ARS)">}}ì™€ {{<emph "Adaptive Rejection Metropolis Sampling (ARMS)">}}ê°€ ìˆìŠµë‹ˆë‹¤. 
ì „ìì˜ ê²½ìš°ëŠ” íš¨ìœ¨ì ì´ì§€ë§Œ í•¨ìˆ˜ê°€ ë°˜ë“œì‹œ ë¡œê·¸-ì˜¤ëª©(log-concave)í•˜ë‹¤ëŠ” ë³´ì¥ì´ ìˆì–´ì•¼ í•˜ê³  í›„ìì˜ ê²½ìš°ëŠ” ì´ë¥¼ í•´ê²°í•˜ì—¬ ì¼ë°˜í™”í–ˆì§€ë§Œ êµ¬í˜„ì´ ìƒë‹¹íˆ ì–´ë µìŠµë‹ˆë‹¤. ë¬¼ë¡  ì´ë¯¸ ì˜ ë§Œë“¤ì–´ì§„ [R package](https://cran.r-project.org/web/packages/armspp/vignettes/arms.html) ë“±ì´ ìˆìœ¼ë‹ˆ ì‚¬ìš©í•˜ëŠ” ê²ƒ ìì²´ëŠ” ì–´ë µì§€ ì•ŠìŠµë‹ˆë‹¤ë§Œ, ì—¬ê¸°ì„œëŠ” ë” ê°„ë‹¨í•œ ë°©ë²•ì„ ì†Œê°œí•˜ê³ ì í•©ë‹ˆë‹¤. ë°”ë¡œ {{<emph "Piecewise Rejection Sampling (PRS)">}}ì…ë‹ˆë‹¤. ì´ëŠ” ì œê°€ ë¬¼ë¦¬í•™ ì—°êµ¬ë¥¼ ìˆ˜í–‰í•˜ë˜ ì¤‘ì— ì²˜ìŒì— ì œì‹œí•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ ì ë§Œë“  ë°©ë²•ìœ¼ë¡œ, ê¸°ë³¸ì ì¸ í† ëŒ€ëŠ” Rejection samplingê³¼ ê°™ì§€ë§Œ $g(x)$ë¥¼ ë‹¨ìˆœí•œ Uniform distributionì´ ì•„ë‹Œ $f(x)$ì— ìµœì í™”ëœ {{<emph "Weighted uniform distribution">}} (ê°€ì¤‘ê· ë“±ë¶„í¬)ë¡œ ìƒì •í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. ì´ë¥¼ ì°¨ê·¼ì°¨ê·¼ ì„¤ëª…í•´ë³´ê² ìŠµë‹ˆë‹¤.

### 2.1. Max-Pooling

&emsp;&emsp;ì•„ë§ˆ ë”¥ëŸ¬ë‹ì— ê´€ì‹¬ìˆëŠ” ì‚¬ëŒì´ë¼ë©´ {{<emph "Max Pooling">}}ì´ë¼ëŠ” ê°œë…ì„ ìµíˆ ë“¤ì–´ë´¤ì„ê²ë‹ˆë‹¤. CNNì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” Max poolingì€ ì‚¬ì‹¤ ê°œë…ì€ êµ‰ì¥íˆ ê°„ë‹¨í•©ë‹ˆë‹¤. ì¼ë‹¨ Max poolingì˜ ìˆ˜í•™ì  ì •ì˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

{{<note title="Max pooling">}}
Let $f\\,:\\,[a,b]\to \mathbb{R}$ be a continuous function and consider the equidistant partition of the interval $[a,b]$
$$
a = x_0 < x_1 < \cdots < x_{n-1} < x_n = b
$$
The partitions size, $(b-a)/n$ is called *stride*. Denote by $\displaystyle M_i = \max_{[x_{i-1},x_i]}f(x)$ and consider
the simple function

$$
S_n(x) = \sum_{i=1}^n M_i ğŸ™_{[x_{i-1},x_i)}(x).
$$

The process of approximating the function $f(x)$ by the simple function $S_n(x)$ is called *max-pooling*.
{{</note>}}

ì—¬ê¸°ì„œ ì‚¬ìš©í•œ simple functionì´ë€ ì¸¡ë„ë¡ (Measure theory)ì—ì„œ ë“±ì¥í•˜ëŠ” í•¨ìˆ˜ë¡œ ê° êµ¬ê°„ì—ì„œ ì„œë¡œ ë‹¤ë¥¸ ìƒìˆ˜ë¥¼ ê°€ì§€ëŠ” í•¨ìˆ˜ë¥¼ ë§í•©ë‹ˆë‹¤. ìì„¸í•œ ì •ì˜ëŠ” [Precise Machine Learning with Rust](https://axect.github.io/ML_with_Rust/measuretheory.html)ì˜ Definition 10ê³¼ Property 1ì„ ì°¸ê³ í•˜ì‹œë©´ ë©ë‹ˆë‹¤. 

ê²°êµ­ Max-poolingì´ë€ ê°„ë‹¨íˆ ë§í•´ $f(x)$ë¥¼ $n$ê°œì˜ êµ¬ê°„ìœ¼ë¡œ ë‚˜ëˆ„ê³  ê° êµ¬ê°„ì—ì„œ $f(x)$ì˜ ìµœëŒ€ê°’ì„ êµ¬í•˜ì—¬ ì´ë¥¼ ê° êµ¬ê°„ì—ì„œì˜ ëŒ€í‘¯ê°’(Representative value)ìœ¼ë¡œ ê°–ëŠ” simple functionì„ êµ¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ë¥¼ ì²˜ìŒ ì œì‹œí•œ ë¶„í¬ì— ëŒ€í•´ ì ìš©í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

{{<img src="/posts/images/006_04_prs.svg" caption="Max-pooling for Test Distribution" width="90%" align="center">}}

ê·¸ë¦¼ì˜ ë¹¨ê°„ìƒ‰ ì‹¤ì„ ì„ $f(x)$ë¼ í•˜ë©´ íŒŒë€ìƒ‰ ì ì„ ì€ $f(x)$ë¥¼ max-poolingí•œ ê²°ê³¼ì…ë‹ˆë‹¤. ì´ì¯¤ë˜ë©´ ì´ë¯¸ ëˆˆì¹˜ì±ˆ ë¶„ë“¤ë„ ìˆì„í…ë°, ì €í¬ëŠ” ì´ íŒŒë€ìƒ‰ ì ì„ ì„ Rejection samplingì—ì„œì˜ $M\cdot g(x)$ë¡œ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ìš°ë¦¬ëŠ” ê° êµ¬ê°„ë³„ë¡œëŠ” ê· ë“±ë¶„í¬ì˜ í˜•íƒœë¥¼ ê°–ì§€ë§Œ ê°ê° ë‹¤ë¥¸ ëŒ€í‘¯ê°’ì„ ê°–ëŠ” í™•ë¥ ë¶„í¬ë¥¼ ì •ì˜í•  ê²ƒì…ë‹ˆë‹¤. ì´ê²ƒì´ ë°”ë¡œ ìœ„ì—ì„œ ì–¸ê¸‰í–ˆë˜ {{<emph "Weighted uniform distribution">}}(ê°€ì¤‘ê· ë“±ë¶„í¬)ì…ë‹ˆë‹¤.

### 2.2. Weighted Uniform Distribution

{{<note title="Weighted uniform distribution">}}
Let $(S, \mathcal{F}, \mu)$ be a measure space. For a disjoint family $\mathcal{A} = \left\\{A\_i\right\\}\_{i=1}^n \in \mathcal{F}$ of measurable sets with non-zero measure and a family $\mathbf{M} = \\{M\_i\\}\_{i=1}^n$ of non-negative real numbers (but $\sum\_i M\_i > 0$), define the weighted uniform distribution on $S$ by
$$
\text{WUnif}(x|\mathbf{M}, \mathcal{A}) = \frac{1}{\sum_{j}M_j \cdot \mu(A_j)}\sum_i M_i ğŸ™_{A_i}(x)
$$
{{</note>}}

ì •ì˜ëŠ” ë­”ê°€ ë³µì¡í•´ ë³´ì´ì§€ë§Œ, ì´ë¥¼ 1ì°¨ì› êµ¬ê°„ì— ëŒ€í•´ì„œ ì •ì˜í•˜ë©´ êµ‰ì¥íˆ ê°„ë‹¨í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* $S = [a,b]$
* $\mathcal{A} = \left\\{[x\_{i-1},x\_i)\right\\}\_{i=1}^n$ and $\Delta x_i \equiv x_i - x\_{i-1}$
* $\displaystyle \text{WUnif}(x|\mathbf{M}, \mathcal{A}) = \frac{1}{\sum_{j}M_j \cdot \Delta x_j}\sum_i M_i ğŸ™_{A_i}(x)$

ì—¬ê¸°ì„œëŠ” ì–´ì°¨í”¼ ì €í¬ê°€ ì‚¬ìš©í•  ë¶„í¬ê°€ 1ì°¨ì› ë¶„í¬ì´ë¯€ë¡œ ì•ìœ¼ë¡œ ì´ ì •ì˜ë¥¼ ì´ìš©í•˜ì—¬ ê³„ì‚°ì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤. ì¼ë‹¨, ì´ í•¨ìˆ˜ê°€ í™•ë¥ ë°€ë„í•¨ìˆ˜ì„ì€ ê°„ë‹¨íˆ ì¦ëª…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> $$
> \begin{aligned}
> \int_a^b \text{WUnif}(x|\mathbf{M}, \mathcal{A}) dx &= \int_a^b \frac{1}{\sum_{j}M_j \cdot \Delta x_j}\sum_i M_i ğŸ™_{A_i}(x) dx \\\\
> &= \frac{1}{\sum_{j}M_j \cdot \Delta x_j}\sum_i M_i \int_{a}^{b} ğŸ™_{A_i}(x) dx \\\\
> &= \frac{1}{\sum_{j}M_j \cdot \Delta x_j}\sum_i M_i \cdot \Delta x_i \\\\
> &= 1
> \end{aligned}
> $$

Weighted uniform distributionì€ samplingí•˜ê¸°ë„ ì‰½ìŠµë‹ˆë‹¤. sampling ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. ì „ì²´ $n$ê°œì˜ êµ¬ê°„ ì¤‘ì—ì„œ í•œ êµ¬ê°„ì„ ë½‘ìŠµë‹ˆë‹¤. ì´ë•Œ ê° êµ¬ê°„ì˜ í™•ë¥ ì€ $\displaystyle \frac{M\_i \cdot \Delta x\_i}{\sum_{j}M\_j \cdot \Delta x\_j}$ì…ë‹ˆë‹¤. 

2. ê° êµ¬ê°„ì€ Uniform distributionì„ ë”°ë¥´ë¯€ë¡œ, êµ¬ê°„ ë‚´ì—ì„œ Uniform distributionìœ¼ë¡œ í•˜ë‚˜ì˜ ìƒ˜í”Œì„ ë½‘ìŠµë‹ˆë‹¤.

ë§Œì¼ max-poolingì„ ì ìš©í•˜ì—¬ $\mathbf{M}, \mathcal{A}$ë¥¼ ê³¨ëë‹¤ë©´, ê° êµ¬ê°„ì˜ ê¸¸ì´ê°€ ëª¨ë‘ ë™ì¼í•˜ë¯€ë¡œ í™•ë¥ ì—ì„œ êµ¬ê°„ì˜ ê¸¸ì´ í•­ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ê²½ìš°ì— ê° êµ¬ê°„ì˜ í™•ë¥ ì€ $M\_i / \sum_{j}M\_j$ê°€ ë˜ì–´ êµ‰ì¥íˆ ê°„ë‹¨í•´ì§‘ë‹ˆë‹¤.

### 2.3. Piecewise Rejection Sampling

&emsp;&emsp;Weighted uniform distributionë„ samplingë°©ë²•ì„ ì•Œê³  ìˆëŠ” ì—„ì—°í•œ í•˜ë‚˜ì˜ í™•ë¥ ë¶„í¬ì´ë¯€ë¡œ, ì´ë¥¼ Rejection samplingì—ì„œì˜ $g(x)$ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ, í•­ìƒ $f(x)$ë³´ë‹¤ ì»¤ì•¼ëœë‹¤ëŠ” ì¡°ê±´ì„ ë§Œì¡±ì‹œí‚¤ê¸° ìœ„í•˜ì—¬ ì„ì˜ì˜ $\mathbf{M}, \mathcal{A}$ë¥¼ ê³ ë¥´ëŠ” ê²ƒì´ ì•„ë‹Œ max-poolingì„ ì ìš©í•˜ì—¬ $\mathbf{M}, \mathcal{A}$ë¥¼ ì–»ì„ ê²ƒì…ë‹ˆë‹¤. ì´ ê³¼ì •ì„ ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. ì „ì²´ êµ¬ê°„ì„ ëª‡ ê°œì˜ êµ¬ê°„ìœ¼ë¡œ ë‚˜ëˆŒì§€ ê²°ì •í•©ë‹ˆë‹¤. ì´ë•Œ, êµ¬ê°„ì˜ ê°œìˆ˜ë¥¼ $n$ì´ë¼ê³  í•˜ê³  ê° êµ¬ê°„ì˜ ê¸¸ì´ë¥¼ ë™ë“±í•˜ê²Œ ë‚˜ëˆ„ì–´ $\mathcal{A}$ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

2. ë‚˜ëˆ ì§„ êµ¬ê°„ì— ëŒ€í•´ $f(x)$ë¥¼ max-poolingí•˜ì—¬ $\mathbf{M}$ì„ ì–»ìŠµë‹ˆë‹¤.

3. $\mathbf{M}, \mathcal{A}$ë¥¼ ì´ìš©í•˜ì—¬ Weighted uniform distributionì„ ì •ì˜í•©ë‹ˆë‹¤.

4. ì´ë ‡ê²Œ ì •ì˜ëœ Weighted uniform distributionì„ Rejection samplingì—ì„œì˜ $g(x)$ë¡œ ì‚¬ìš©í•˜ì—¬ samplingí•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ sampling ë°©ë²•ì€ ë§ˆì¹˜ êµ¬ê°„ì„ ë‚˜ëˆ„ì–´ samplingí•˜ëŠ” ê²ƒê³¼ ê°™ìœ¼ë¯€ë¡œ {{<emph "Piecewise Rejection Sampling">}}ìœ¼ë¡œ ëª…ëª…í•˜ê² ìŠµë‹ˆë‹¤. ì´ ë°©ë²•ì—ì„œì˜ Acceptance rateë¥¼ êµ¬í•´ë³´ë©´ ë‹¨ìˆœíˆ Uniform distributionì„ ì‚¬ìš©í•˜ì—¬ Rejection samplingì„ í•  ë•Œì— ë¹„í•´ Acceptance rateê°€ ë†’ì•„ì§€ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> $$
> \begin{aligned}
> P(U < f(Y)) &= \int_a^b P(U < f(Y) | Y = y) \cdot g(y) \\, dy \\\\
> &= \int_a^b P(U < f(y)) \cdot \text{WUnif}(y|\mathbf{M}, \mathcal{A}) \\, dy \\\\
> &= \frac{1}{\sum_{j}M_j \cdot \Delta x_j} \sum_i M_i \int_{A_i} P(U < f(y)) dy
> \end{aligned}
> $$
> $U \sim \text{Unif}(u|0, M_i)$ì´ë¯€ë¡œ $P(U < f(y)) = f(y)/{M_i}$ì´ë¯€ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> $$
> \begin{aligned}
> P(U < f(Y)) &= \frac{1}{\sum_{j}M_j \cdot \Delta x_j} \sum_i \int_{A_i} f(y)\\, dy \\\\
> &= \frac{1}{\sum_{j}M_j \cdot \Delta x_j} \geq \frac{1}{M\_\max \cdot \sum\_{j} \Delta x\_j}  = \frac{1}{M}
> \end{aligned}
> $$

ë§ˆì§€ë§‰ ë¶€ë“±ì‹ì€ $M_i$ ì¤‘ì—ì„œ ê°€ì¥ í° ê°’ì— ì „ì²´ êµ¬ê°„ì˜ ê¸¸ì´ë¥¼ ê³±í•˜ë©´ ì›ë˜ Uniform distributionì„ ì‚¬ìš©í•  ë•Œì˜ $M$ê³¼ ê°™ë‹¤ëŠ” ê²ƒì„ ì´ìš©í•˜ì—¬ ì •ë¦¬í•œ ê²ƒì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ Piecewise rejection samplingì˜ Acceptance rateëŠ” Uniform distributionì„ ì‚¬ìš©í•  ë•Œì˜ Acceptance rateë³´ë‹¤ í•­ìƒ ë†’ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ ë§ˆì§€ë§‰ìœ¼ë¡œ ì²˜ìŒì— ì œì‹œí–ˆë˜ ë¬¸ì œë¥¼ Piecewise rejection samplingì„ ì´ìš©í•˜ì—¬ í’€ì–´ë³´ê² ìŠµë‹ˆë‹¤. ìœ„ ì•Œê³ ë¦¬ì¦˜ì€ Rust numeric libraryì¸ [Peroxide](https://github.com/Axect/Peroxide)ì— ì´ë¯¸ êµ¬í˜„ì´ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì´ë¥¼ ì´ìš©í•˜ê² ìŠµë‹ˆë‹¤.

```rust
use peroxide::fuga::*;

#[allow(non_snake_case)]
fn main() {
    let df = DataFrame::read_nc("data/test.nc").unwrap();
    let E: Vec<f64> = df["E"].to_vec();
    let dNdE: Vec<f64> = df["dNdE"].to_vec();

    // Cubic hermite spline -> Make continuous f(x)
    let cs = cubic_hermite_spline(&E, &dNdE, Quadratic);
    let f = |x: f64| cs.eval(x);

    // Piecewise rejection sampling
    // * # samples = 10000
    // * # bins = 100
    // * tolerance = 1e-6
    let E_sample = prs(f, 10000, (E[0], E[E.len()-1]), 100, 1e-6);

    let mut df = DataFrame::new(vec![]);
    df.push("E", Series::new(E_sample));
    df.write_nc("data/prs.nc").unwrap();
}
```
ì´ë ‡ê²Œ ë§Œë“¤ì–´ì§„ ë°ì´í„°ë¥¼ íˆìŠ¤í† ê·¸ë¨ìœ¼ë¡œ ê·¸ë ¤ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

{{<img src="/posts/images/006_05_hist.png" caption="Finally, we get samples!">}}

-----
## References

* **Yen-Chi Chen**, *Lecture 4: Importance Sampling and Rejection Sampling*, STAT/Q SCI 403: Introduction to Resampling Methods (2017)

* **Ovidiu Calin**, *Deep Learning Architectures: A Mathematical Approach*, Springer (2020)

* **Tae-Geun Kim ([Axect](https://github.com/Axect))**, [*Precise Machine Learning with Rust*](https://axect.github.io/ML_with_Rust) (2019)

-----

## A. Footnotes {#footnotes}

[1]: ì—¬ê¸°ì— ì‚¬ìš©ëœ ê·¸ë¦¼ì€ ì›ì‹œë¸”ë™í™€(Primordial Black hole; PBH)ë¡œë¶€í„° íŠ¹ì •ì‹œê°„ì— ë°©ì¶œëœ ì•¡ì‹œì˜¨ìœ ì‚¬ì…ìë“¤(Axion Like Particles; ALPs)ì˜ ìŠ¤í™íŠ¸ëŸ¼ì„ ê·¸ë¦° ê·¸ë¦¼ì…ë‹ˆë‹¤.

[2]: ë¬¼ë¡  ì´ ê²½ìš°ì—ë„, ë…¸ë“œë“¤ì„ cubic spline ë“±ì˜ ë°©ë²•ìœ¼ë¡œ ê·¼ì‚¬í•˜ê³  ìˆ˜ì¹˜ì ë¶„ì´ë‚˜ polynomial ì ë¶„ì„ ì´ìš©í•˜ì—¬ ëˆ„ì ë¶„í¬í•¨ìˆ˜ë¥¼ êµ¬í•œ í›„, ì´ë¥¼ ë‹¤ì‹œ interpolationì´ë‚˜ splineë“±ì˜ ë°©ë²•ìœ¼ë¡œ fittingí•œ í›„ ì—­í•¨ìˆ˜ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê¸´í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ëŠ” ì˜¤ì°¨ê°€ ê½¤ ì‹¬í•˜ê³  ë¹„íš¨ìœ¨ì ì´ë¼ ì¶”ì²œí•˜ì§„ ì•ŠìŠµë‹ˆë‹¤.
